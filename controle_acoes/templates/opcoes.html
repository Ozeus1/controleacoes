{% extends "base.html" %}

{% block content %}

{# ========== TABELA 1: VENDA COBERTA DE CALLS ========== #}
{% if options %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; flex-wrap: wrap; gap: 0.5rem;">
        <h3>Venda Coberta de Calls</h3>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
            <form action="{{ url_for('update_options_quotes') }}" method="post" style="margin: 0;">
                <button type="submit" class="btn btn-secondary btn-sm">üîÑ Atualizar Ativos</button>
            </form>
            <a href="{{ url_for('add_option', type='VENDA_CALL') }}" class="btn btn-primary btn-sm">Adicionar Op√ß√£o</a>
        </div>
    </div>
    <table>
        <thead>
            <tr>
                <th>Op√ß√£o</th>
                <th>Qtd</th>
                <th>Ativo</th>
                <th>Cota√ß√£o Ativo</th>
                <th>Pre√ßo M√©dio</th>
                <th>Strike</th>
                <th>Vencimento</th>
                <th>Valor Venda</th>
                <th>Pre√ßo Exerc√≠cio</th>
                <th>Lastro</th>
                <th>Total</th>
                <th>Cota√ß√£o Op√ß√£o</th>
                <th>Lucro R$</th>
                <th>Lucro %</th>
                <th>Lucro A√ß√£o Ex.R$</th>
                <th>Lucro A√ß√£o Ex.%</th>
                <th>Lucro A√ß√£o At.R$</th>
                <th>Lucro A√ß√£o At.%</th>
                <th>A√ß√µes</th>
            </tr>
        </thead>
        <tbody>
            {% for item in options %}
            <tr>
                <td><span class="ticker-badge">{{ item.option.ticker }}</span></td>
                <td>{{ item.option.quantity }}</td>
                <td>{{ item.option.underlying_asset }}</td>
                <td>R$ {{ "%.2f"|format(item.underlying_price)|replace('.', ',') }}</td>
                <td>R$ {{ "%.2f"|format(item.avg_price)|replace('.', ',') }}</td>
                <td>R$ {{ "%.2f"|format(item.option.strike_price)|replace('.', ',') }}</td>
                <td>{{ item.option.expiration_date.strftime('%d/%m/%Y') }}</td>
                <td>R$ {{ "%.2f"|format(item.option.sale_price)|replace('.', ',') }}</td>
                <td>R$ {{ "%.2f"|format(item.exercise_price)|replace('.', ',') }}</td>
                <td class="{{ 'positive' if item.lastro >= 0 else 'negative' }}">
                    R$ {{ "%.2f"|format(item.lastro)|replace('.', ',') }}
                </td>
                <td>R$ {{ "%.2f"|format(item.total_sold)|replace('.', ',') }}</td>
                <td data-optticker="{{ item.option.ticker }}" data-field="opt_price">R$ {{ "%.2f"|format(item.option.current_option_price)|replace('.', ',') }}</td>
                <td class="{{ 'positive' if item.profit >= 0 else 'negative' }}">
                    R$ {{ "%.2f"|format(item.profit)|replace('.', ',') }}
                </td>
                <td class="{{ 'positive' if item.profit_pct >= 0 else 'negative' }}">
                    {{ "%.2f"|format(item.profit_pct)|replace('.', ',') }}%
                </td>
                <td class="{{ 'positive' if item.lucro_ex_rs >= 0 else 'negative' }}">
                    R$ {{ "%.2f"|format(item.lucro_ex_rs)|replace('.', ',') }}
                </td>
                <td class="{{ 'positive' if item.lucro_ex_pct >= 0 else 'negative' }}">
                    {{ "%.2f"|format(item.lucro_ex_pct)|replace('.', ',') }}%
                </td>
                <td class="{{ 'positive' if item.lucro_at_rs >= 0 else 'negative' }}">
                    R$ {{ "%.2f"|format(item.lucro_at_rs)|replace('.', ',') }}
                </td>
                <td class="{{ 'positive' if item.lucro_at_pct >= 0 else 'negative' }}">
                    {{ "%.2f"|format(item.lucro_at_pct)|replace('.', ',') }}%
                </td>

                <td class="actions">
                    <a href="{{ url_for('close_option', id=item.option.id) }}" class="btn btn-sm"
                        style="background:var(--accent-color); color: white;" title="Gravar Sa√≠da">üõë</a>
                    <a href="{{ url_for('edit_option', id=item.option.id) }}" class="btn btn-sm btn-primary">‚úèÔ∏è</a>
                    <a href="{{ url_for('delete_option', id=item.option.id) }}" class="btn btn-sm btn-danger"
                        onclick="return confirm('Apagar?')">üóëÔ∏è</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr class="total-row" style="font-weight: bold; background-color: var(--total-row-bg);">
                <td>TOTAL</td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td>{{ options|sum(attribute='total_sold') | brl }}</td>
                <td></td>
                <td class="{{ 'positive' if options|sum(attribute='profit') >= 0 else 'negative' }}">
                    {{ options|sum(attribute='profit') | brl }}
                </td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
        </tfoot>
    </table>
</div>
{% else %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; flex-wrap: wrap; gap: 0.5rem;">
        <h3>Venda Coberta de Calls</h3>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
            <form action="{{ url_for('update_options_quotes') }}" method="post" style="margin: 0;">
                <button type="submit" class="btn btn-secondary btn-sm">üîÑ Atualizar Ativos</button>
            </form>
            <a href="{{ url_for('add_option', type='VENDA_CALL') }}" class="btn btn-primary btn-sm">Adicionar Op√ß√£o</a>
        </div>
    </div>
    <p style="text-align: center; padding: 2rem; color: var(--text-secondary);">Sem op√ß√µes de venda coberta cadastradas</p>
</div>
{% endif %}

{# ========== TABELA 2: COMPRA A SECO - CALLS ITM ========== #}
{% if compra_calls %}
<div class="card" style="margin-top: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; flex-wrap: wrap; gap: 0.5rem;">
        <h3>Compra a Seco - Calls ITM</h3>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
            <a href="{{ url_for('add_option', type='COMPRA_CALL') }}" class="btn btn-primary btn-sm">Adicionar Call</a>
        </div>
    </div>
    <table>
        <thead>
            <tr>
                <th>Op√ß√£o</th>
                <th>Qtd</th>
                <th>Ativo</th>
                <th>Cota√ß√£o Ativo</th>
                <th>Strike</th>
                <th>Vencimento</th>
                <th>Valor Compra</th>
                <th>Total Investido</th>
                <th>Cota√ß√£o Op√ß√£o</th>
                <th>Valor Atual</th>
                <th>Lucro R$</th>
                <th>Lucro %</th>
                <th>A√ß√µes</th>
            </tr>
        </thead>
        <tbody>
            {% for item in compra_calls %}
            <tr>
                <td><span class="ticker-badge">{{ item.option.ticker }}</span></td>
                <td>{{ item.option.quantity }}</td>
                <td>{{ item.option.underlying_asset }}</td>
                <td>R$ {{ "%.2f"|format(item.underlying_price)|replace('.', ',') }}</td>
                <td>R$ {{ "%.2f"|format(item.option.strike_price)|replace('.', ',') }}</td>
                <td>{{ item.option.expiration_date.strftime('%d/%m/%Y') }}</td>
                <td>R$ {{ "%.2f"|format(item.option.sale_price)|replace('.', ',') }}</td>
                <td>R$ {{ "%.2f"|format(item.total_invested)|replace('.', ',') }}</td>
                <td data-optticker="{{ item.option.ticker }}" data-field="opt_price">R$ {{ "%.2f"|format(item.option.current_option_price)|replace('.', ',') }}</td>
                <td data-optticker="{{ item.option.ticker }}" data-field="opt_value" data-qty="{{ item.option.quantity }}">R$ {{ "%.2f"|format(item.current_value)|replace('.', ',') }}</td>
                <td class="{{ 'positive' if item.profit >= 0 else 'negative' }}">
                    R$ {{ "%.2f"|format(item.profit)|replace('.', ',') }}
                </td>
                <td class="{{ 'positive' if item.profit_pct >= 0 else 'negative' }}">
                    {{ "%.2f"|format(item.profit_pct)|replace('.', ',') }}%
                </td>
                <td class="actions">
                    <a href="{{ url_for('close_option', id=item.option.id) }}" class="btn btn-sm"
                        style="background:var(--accent-color); color: white;" title="Gravar Sa√≠da">üõë</a>
                    <a href="{{ url_for('edit_option', id=item.option.id) }}" class="btn btn-sm btn-primary">‚úèÔ∏è</a>
                    <a href="{{ url_for('delete_option', id=item.option.id) }}" class="btn btn-sm btn-danger"
                        onclick="return confirm('Apagar?')">üóëÔ∏è</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr class="total-row" style="font-weight: bold; background-color: var(--total-row-bg);">
                <td>TOTAL</td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td>{{ compra_calls|sum(attribute='total_invested') | brl }}</td>
                <td></td>
                <td>{{ compra_calls|sum(attribute='current_value') | brl }}</td>
                <td class="{{ 'positive' if compra_calls|sum(attribute='profit') >= 0 else 'negative' }}">
                    {{ compra_calls|sum(attribute='profit') | brl }}
                </td>
                <td></td>
                <td></td>
            </tr>
        </tfoot>
    </table>
</div>
{% else %}
<div class="card" style="margin-top: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; flex-wrap: wrap; gap: 0.5rem;">
        <h3>Compra a Seco - Calls ITM</h3>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
            <a href="{{ url_for('add_option', type='COMPRA_CALL') }}" class="btn btn-primary btn-sm">Adicionar Call</a>
        </div>
    </div>
    <p style="text-align: center; padding: 2rem; color: var(--text-secondary);">Sem compras a seco de Calls cadastradas</p>
</div>
{% endif %}

{# ========== TABELA 3: COMPRA A SECO - PUTS ========== #}
{% if compra_puts %}
<div class="card" style="margin-top: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; flex-wrap: wrap; gap: 0.5rem;">
        <h3>Compra a Seco - Puts</h3>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
            <a href="{{ url_for('add_option', type='COMPRA_PUT') }}" class="btn btn-primary btn-sm">Adicionar Put</a>
        </div>
    </div>
    <table>
        <thead>
            <tr>
                <th>Op√ß√£o</th>
                <th>Qtd</th>
                <th>Ativo</th>
                <th>Cota√ß√£o Ativo</th>
                <th>Strike</th>
                <th>Vencimento</th>
                <th>Valor Compra</th>
                <th>Total Investido</th>
                <th>Cota√ß√£o Op√ß√£o</th>
                <th>Valor Atual</th>
                <th>Lucro R$</th>
                <th>Lucro %</th>
                <th>A√ß√µes</th>
            </tr>
        </thead>
        <tbody>
            {% for item in compra_puts %}
            <tr>
                <td><span class="ticker-badge">{{ item.option.ticker }}</span></td>
                <td>{{ item.option.quantity }}</td>
                <td>{{ item.option.underlying_asset }}</td>
                <td>R$ {{ "%.2f"|format(item.underlying_price)|replace('.', ',') }}</td>
                <td>R$ {{ "%.2f"|format(item.option.strike_price)|replace('.', ',') }}</td>
                <td>{{ item.option.expiration_date.strftime('%d/%m/%Y') }}</td>
                <td>R$ {{ "%.2f"|format(item.option.sale_price)|replace('.', ',') }}</td>
                <td>R$ {{ "%.2f"|format(item.total_invested)|replace('.', ',') }}</td>
                <td data-optticker="{{ item.option.ticker }}" data-field="opt_price">R$ {{ "%.2f"|format(item.option.current_option_price)|replace('.', ',') }}</td>
                <td data-optticker="{{ item.option.ticker }}" data-field="opt_value" data-qty="{{ item.option.quantity }}">R$ {{ "%.2f"|format(item.current_value)|replace('.', ',') }}</td>
                <td class="{{ 'positive' if item.profit >= 0 else 'negative' }}">
                    R$ {{ "%.2f"|format(item.profit)|replace('.', ',') }}
                </td>
                <td class="{{ 'positive' if item.profit_pct >= 0 else 'negative' }}">
                    {{ "%.2f"|format(item.profit_pct)|replace('.', ',') }}%
                </td>
                <td class="actions">
                    <a href="{{ url_for('close_option', id=item.option.id) }}" class="btn btn-sm"
                        style="background:var(--accent-color); color: white;" title="Gravar Sa√≠da">üõë</a>
                    <a href="{{ url_for('edit_option', id=item.option.id) }}" class="btn btn-sm btn-primary">‚úèÔ∏è</a>
                    <a href="{{ url_for('delete_option', id=item.option.id) }}" class="btn btn-sm btn-danger"
                        onclick="return confirm('Apagar?')">üóëÔ∏è</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr class="total-row" style="font-weight: bold; background-color: var(--total-row-bg);">
                <td>TOTAL</td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td>{{ compra_puts|sum(attribute='total_invested') | brl }}</td>
                <td></td>
                <td>{{ compra_puts|sum(attribute='current_value') | brl }}</td>
                <td class="{{ 'positive' if compra_puts|sum(attribute='profit') >= 0 else 'negative' }}">
                    {{ compra_puts|sum(attribute='profit') | brl }}
                </td>
                <td></td>
                <td></td>
            </tr>
        </tfoot>
    </table>
</div>
{% else %}
<div class="card" style="margin-top: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; flex-wrap: wrap; gap: 0.5rem;">
        <h3>Compra a Seco - Puts</h3>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
            <a href="{{ url_for('add_option', type='COMPRA_PUT') }}" class="btn btn-primary btn-sm">Adicionar Put</a>
        </div>
    </div>
    <p style="text-align: center; padding: 2rem; color: var(--text-secondary);">Sem compras a seco de Puts cadastradas</p>
</div>
{% endif %}

<!-- MT5 Live Polling for Options -->
<script>
(function() {
    const POLL_URL = "{{ url_for('api_current_quotes') }}";
    const INTERVAL = 15000;
    function fmtBRL(v) { return 'R$ ' + v.toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2}); }
    function applyQuotes(assets, options) {
        // Update option prices
        document.querySelectorAll('[data-field="opt_price"]').forEach(function(el) {
            const d = options[el.dataset.optticker]; if (d) el.textContent = fmtBRL(d.price);
        });
        // Update option current value (qty * price)
        document.querySelectorAll('[data-field="opt_value"]').forEach(function(el) {
            const d = options[el.dataset.optticker];
            if (d) el.textContent = fmtBRL(parseFloat(el.dataset.qty) * d.price);
        });
    }
    function poll() {
        fetch(POLL_URL).then(r => r.json()).then(function(data) {
            if (data.mode === 'mt5') applyQuotes(data.assets, data.options);
        }).catch(function(){});
    }
    fetch(POLL_URL).then(r => r.json()).then(function(data) {
        if (data.mode !== 'mt5') return;
        applyQuotes(data.assets, data.options);
        setInterval(poll, INTERVAL);
        if (!document.getElementById('mt5-badge')) {
            var b = document.createElement('div');
            b.id = 'mt5-badge';
            b.style.cssText = 'position:fixed;bottom:1rem;right:1rem;background:var(--success-color);color:#fff;padding:0.4rem 1rem;border-radius:20px;font-size:0.85rem;z-index:9999;box-shadow:0 2px 8px rgba(0,0,0,0.3);';
            b.textContent = '‚ö° MT5 ao vivo';
            document.body.appendChild(b);
        }
    }).catch(function(){});
})();
</script>
{% endblock %}
