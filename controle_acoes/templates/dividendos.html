{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-12 d-flex justify-content-between align-items-center">
        <h2>üí∞ Dividendos & Proventos</h2>
        <form action="{{ url_for('update_dividends') }}" method="POST"
            onsubmit="this.querySelector('button').disabled=true; this.querySelector('button').innerHTML='<i class=\'fas fa-spinner fa-spin\'></i> Atualizando...';">
            <button type="submit" class="btn btn-warning font-weight-bold">
                <i class="fas fa-sync-alt"></i> Atualizar Dados (Yahoo)
            </button>
        </form>
    </div>
</div>

<div class="row mb-4">
    <!-- CHART (Full Width Row, Centered Content) -->
    <div class="col-12">
        <div class="card bg-dark text-white h-100">
            <div class="card-header font-weight-bold text-center">Total por Tipo</div>
            <div class="card-body d-flex justify-content-center align-items-center">
                <div style="width: 300px; height: 300px;">
                    <canvas id="divChart"></canvas>
                </div>
            </div>
            <div class="card-footer text-center">
                <h3 class="text-success">Total: {{ total_received | brl }}</h3>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <!-- ASSETS CONFIG (Full Width Row) -->
    <div class="col-12">
        <div class="card bg-dark text-white h-100">
            <div class="card-header font-weight-bold d-flex justify-content-between align-items-center">
                <span>Configura√ß√£o de Data de Compra</span>
                <button class="btn btn-sm btn-outline-light" type="button" data-bs-toggle="collapse"
                    data-bs-target="#configTable" aria-expanded="false" aria-controls="configTable">
                    <i class="fas fa-cog"></i> Configurar
                </button>
            </div>
            <div class="collapse" id="configTable">
                <div class="card-body p-0 table-responsive" style="max-height: 400px;">
                    <table class="table table-dark table-striped mb-0 table-sm align-middle">
                        <thead>
                            <tr>
                                <th>Ticker</th>
                                <th>Tipo</th>
                                <th>Qtd</th>
                                <th>Data Compra (In√≠cio)</th>
                                <th>A√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for asset in assets %}
                            <tr>
                                <td>{{ asset.ticker }}</td>
                                <td>{{ asset.type }}</td>
                                <td>{{ asset.quantity }}</td>
                                <td>
                                    <form action="{{ url_for('update_asset_date', id=asset.id) }}" method="POST"
                                        class="d-flex align-items-center gap-2 justify-content-center">
                                        <input type="date" name="entry_date"
                                            class="form-control form-control-sm bg-secondary text-white border-0"
                                            value="{{ asset.entry_date.strftime('%Y-%m-%d') if asset.entry_date else '' }}"
                                            required style="max-width: 150px;">
                                        <button type="submit" class="btn btn-sm btn-info" title="Salvar Data">
                                            <i class="fas fa-save"></i>
                                        </button>
                                    </form>
                                </td>
                                <td>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MONTHLY EVOLUTION CHART -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card bg-dark text-white h-100">
            <div class="card-header font-weight-bold d-flex justify-content-between align-items-center">
                <span><i class="fas fa-chart-line mr-2"></i>Evolu√ß√£o de Proventos</span>
                <div class="form-inline">
                    <select id="chartFilter" class="form-control form-control-sm bg-secondary text-white border-0"
                        onchange="updateChartType()">
                        <option value="total">Total</option>
                        <option value="acoes">A√ß√µes (Dividendos)</option>
                        <option value="fiis">FIIs (Rendimentos)</option>
                    </select>
                </div>
            </div>
            <div class="card-body">
                <div style="height: 300px; width: 100%;">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- FUTURE DIVIDENDS TABLE -->
{% if dividends_provisioned %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card bg-dark text-white border-info">
            <div class="card-header font-weight-bold text-info">
                <i class="fas fa-calendar-alt mr-2"></i>Proventos a Receber (Futuros)
            </div>
            <div class="card-body p-0 table-responsive">
                <table class="table table-dark table-hover mb-0 text-center">
                    <thead>
                        <tr class="text-secondary">
                            <th>Ticker</th>
                            <th>Tipo</th>
                            <th>Data Com</th>
                            <th>Data Pagamento</th>
                            <th>Valor</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for div in dividends_provisioned %}
                        <tr>
                            <td class="font-weight-bold">{{ div.ticker }}</td>
                            <td><span class="badge badge-secondary">{{ div.type }}</span></td>
                            <td>{{ div.ex_date.strftime('%d/%m/%Y') if div.ex_date else '-' }}</td>
                            <td class="text-warning font-weight-bold">{{ div.payment_date.strftime('%d/%m/%Y') if
                                div.payment_date else '-' }}</td>
                            <td class="text-success font-weight-bold">{{ div.amount | brl }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- DIVIDENDS HISTORY TABLE -->
<div class="row">
    <div class="col-12">
        <div class="card bg-dark text-white">
            <div class="card-header font-weight-bold d-flex justify-content-between align-items-center">
                <span><i class="fas fa-history mr-2"></i>Hist√≥rico de Proventos (Recebidos)</span>
                <span class="badge badge-success">{{ dividends_received|length }} Pagamentos</span>
            </div>
            <div class="card-body p-0 table-responsive" style="max-height: 500px; overflow-y: auto;">
                <table class="table table-dark table-striped mb-0 text-center" id="dividendsTable">
                    <thead style="position: sticky; top: 0; background-color: #343a40; z-index: 1;">
                        <tr>
                            <th>Data Pagamento</th>
                            <th>Data Com (Ex)</th>
                            <th>Ticker</th>
                            <th>Tipo</th>
                            <th>Valor Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for div in dividends_received %}
                        <tr>
                            <td>{{ div.payment_date.strftime('%d/%m/%Y') if div.payment_date else '-' }}</td>
                            <td>{{ div.ex_date.strftime('%d/%m/%Y') if div.ex_date else '-' }}</td>
                            <td class="font-weight-bold text-info">{{ div.ticker }}</td>
                            <td>{{ div.type }}</td>
                            <td class="text-success font-weight-bold">{{ div.amount | brl }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Chart Data
    const divData = {{ div_chart_data | tojson }};
    const monthlyDataRaw = {{ monthly_chart_data | tojson }};

    //--- Doughnut Chart ---
    const ctx = document.getElementById('divChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(divData),
            datasets: [{
                data: Object.values(divData),
                backgroundColor: ['#28a745', '#17a2b8'], // Green (Stocks), Cyan (FIIs)
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { color: 'white' }
                }
            }
        }
    });

    //--- Monthly Bar Chart (Dynamic) ---
    const ctxMonthly = document.getElementById('monthlyChart').getContext('2d');

    // Gradients
    const gradientTotal = ctxMonthly.createLinearGradient(0, 0, 0, 400);
    gradientTotal.addColorStop(0, '#4facfe'); gradientTotal.addColorStop(1, '#00f2fe');

    const gradientStocks = ctxMonthly.createLinearGradient(0, 0, 0, 400);
    gradientStocks.addColorStop(0, '#43e97b'); gradientStocks.addColorStop(1, '#38f9d7');

    const gradientFIIs = ctxMonthly.createLinearGradient(0, 0, 0, 400);
    gradientFIIs.addColorStop(0, '#fa709a'); gradientFIIs.addColorStop(1, '#fee140');

    let currentGradient = gradientTotal;

    const barChart = new Chart(ctxMonthly, {
        type: 'bar',
        data: {
            labels: monthlyDataRaw.labels,
            datasets: [{
                label: 'Total',
                data: monthlyDataRaw.total,
                backgroundColor: gradientTotal,
                borderRadius: 4,
                barPercentage: 0.7
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                    ticks: { color: 'white', callback: function (value) { return 'R$ ' + value; } }
                },
                x: {
                    grid: { display: false },
                    ticks: { color: 'white' }
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(context.parsed.y);
                        }
                    }
                }
            }
        }
    });

    function updateChartType() {
        const type = document.getElementById('chartFilter').value;
        let newData = [];
        let newLabel = '';
        let newGradient = gradientTotal;

        if (type === 'total') {
            newData = monthlyDataRaw.total;
            newLabel = 'Total';
            newGradient = gradientTotal;
        } else if (type === 'acoes') {
            newData = monthlyDataRaw.acoes;
            newLabel = 'Dividendos (A√ß√µes)';
            newGradient = gradientStocks;
        } else if (type === 'fiis') {
            newData = monthlyDataRaw.fiis;
            newLabel = 'Rendimentos (FIIs)';
            newGradient = gradientFIIs;
        }

        barChart.data.datasets[0].data = newData;
        barChart.data.datasets[0].label = newLabel;
        barChart.data.datasets[0].backgroundColor = newGradient;
        barChart.update();
    }
</script>
{% endblock %}