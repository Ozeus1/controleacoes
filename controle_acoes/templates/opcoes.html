{% extends "base.html" %}

{% block content %}
{% if options %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; flex-wrap: wrap; gap: 0.5rem;">
        <h3>Carteira de Op√ß√µes</h3>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
            <form action="{{ url_for('update_options_quotes') }}" method="post" style="margin: 0;">
                <button type="submit" class="btn btn-secondary btn-sm">üîÑ Atualizar Ativos</button>
            </form>
            <a href="{{ url_for('add_option') }}" class="btn btn-primary btn-sm">Adicionar Op√ß√£o</a>
        </div>
    </div>
    <table>
        <thead>
            <tr>
                <th>Op√ß√£o</th>
                <th>Qtd</th>
                <th>Ativo</th>
                <th>Cota√ß√£o Ativo</th>
                <th>Pre√ßo M√©dio</th>
                <th>Strike</th>
                <th>Vencimento</th>
                <th>Valor Venda</th>
                <th>Pre√ßo Exerc√≠cio</th>
                <th>Lastro</th>
                <th>Total</th>
                <th>Cota√ß√£o Op√ß√£o</th>
                <th>Lucro R$</th>
                <th>Lucro %</th>
                <th>Lucro A√ß√£o Ex.%</th>
                <th>Lucro A√ß√£o At.%</th>
                <th>A√ß√µes</th>
            </tr>
        </thead>
        <tbody>
            {% for item in options %}
            <tr>
                <td><span class="ticker-badge">{{ item.option.ticker }}</span></td>
                <td>{{ item.option.quantity }}</td>
                <td>{{ item.option.underlying_asset }}</td>
                <td>R$ {{ "%.2f"|format(item.underlying_price)|replace('.', ',') }}</td>
                <td>R$ {{ "%.2f"|format(item.avg_price)|replace('.', ',') }}</td>
                <td>R$ {{ "%.2f"|format(item.option.strike_price)|replace('.', ',') }}</td>
                <td>{{ item.option.expiration_date.strftime('%d/%m/%Y') }}</td>
                <td>R$ {{ "%.2f"|format(item.option.sale_price)|replace('.', ',') }}</td>
                <td>R$ {{ "%.2f"|format(item.exercise_price)|replace('.', ',') }}</td>
                <td class="{{ 'positive' if item.lastro >= 0 else 'negative' }}">
                    R$ {{ "%.2f"|format(item.lastro)|replace('.', ',') }}
                </td>
                <td>R$ {{ "%.2f"|format(item.total_sold)|replace('.', ',') }}</td>
                <td>R$ {{ "%.2f"|format(item.option.current_option_price)|replace('.', ',') }}</td>
                <td class="{{ 'positive' if item.profit >= 0 else 'negative' }}">
                    R$ {{ "%.2f"|format(item.profit)|replace('.', ',') }}
                </td>
                <td class="{{ 'positive' if item.profit_pct >= 0 else 'negative' }}">
                    {{ "%.2f"|format(item.profit_pct)|replace('.', ',') }}%
                </td>
                <td class="{{ 'positive' if item.lucro_ex_pct >= 0 else 'negative' }}">
                    {{ "%.2f"|format(item.lucro_ex_pct)|replace('.', ',') }}%
                </td>
                <td class="{{ 'positive' if item.lucro_at_pct >= 0 else 'negative' }}">
                    {{ "%.2f"|format(item.lucro_at_pct)|replace('.', ',') }}%
                </td>

                <td class="actions">
                    <a href="{{ url_for('close_option', id=item.option.id) }}" class="btn btn-sm"
                        style="background:var(--accent-color); color: white;" title="Gravar Sa√≠da">üõë</a>
                    <a href="{{ url_for('edit_option', id=item.option.id) }}" class="btn btn-sm btn-primary">‚úèÔ∏è</a>
                    <a href="{{ url_for('delete_option', id=item.option.id) }}" class="btn btn-sm btn-danger"
                        onclick="return confirm('Apagar?')">üóëÔ∏è</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr class="total-row" style="font-weight: bold; background-color: rgba(255,255,255,0.05);">
                <td>TOTAL</td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td>{{ options|sum(attribute='total_sold') | brl }}</td>
                <td></td>
                <td class="{{ 'positive' if options|sum(attribute='profit') >= 0 else 'negative' }}">
                    {{ options|sum(attribute='profit') | brl }}
                </td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
        </tfoot>
    </table>
</div>
{% else %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; flex-wrap: wrap; gap: 0.5rem;">
        <h3>Carteira de Op√ß√µes</h3>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
            <form action="{{ url_for('update_options_quotes') }}" method="post" style="margin: 0;">
                <button type="submit" class="btn btn-secondary btn-sm">üîÑ Atualizar Ativos</button>
            </form>
            <a href="{{ url_for('add_option') }}" class="btn btn-primary btn-sm">Adicionar Op√ß√£o</a>
        </div>
    </div>
    <p style="text-align: center; padding: 2rem; color: var(--text-secondary);">Sem Op√ß√µes Cadastradas</p>
</div>
{% endif %}
{% endblock %}