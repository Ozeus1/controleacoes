{% extends "base.html" %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; flex-wrap: wrap; gap: 0.5rem;">
        <h3>Hist√≥rico de Trades</h3>
        <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
            <select id="strategyFilter" onchange="filterByStrategy()" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; border-radius: 0.5rem; background-color: #0f172a; border: 1px solid var(--border-color); color: white;">
                <option value="">Todas Estrat√©gias</option>
                {% for s in strategies %}
                <option value="{{ s }}">{{ s }}</option>
                {% endfor %}
            </select>
            <a href="{{ url_for('add_history') }}" class="btn btn-primary btn-sm">+ Adicionar Trade</a>
        </div>
    </div>

    <div style="font-size: 1.1rem; padding: 0 1rem 1rem;">
        Lucro Total: <span class="{{ 'positive' if total_profit >= 0 else 'negative' }}" style="font-weight: 700;">
            R$ {{ "%.2f"|format(total_profit)|replace('.', ',') }}
        </span>
    </div>

    <table id="historyTable">
        <thead>
            <tr>
                <th>Ticker</th>
                <th>Estrat√©gia</th>
                <th>Entrada</th>
                <th>Sa√≠da</th>
                <th>Qtd</th>
                <th>Pre√ßo Compra</th>
                <th>Pre√ßo Venda</th>
                <th>Resultado</th>
                <th>%</th>
                <th>Dias</th>
                <th>A√ß√µes</th>
            </tr>
        </thead>
        <tbody>
            {% for trade in trades %}
            <tr data-strategy="{{ trade.strategy or 'Outros' }}">
                <td><span class="ticker-badge">{{ trade.ticker }}</span></td>
                <td>{{ trade.strategy or 'Outros' }}</td>
                <td data-order="{{ trade.entry_date.strftime('%Y-%m-%d') if trade.entry_date else '' }}">
                    {{ trade.entry_date.strftime('%d/%m/%Y') if trade.entry_date else '-' }}
                </td>
                <td data-order="{{ trade.exit_date.strftime('%Y-%m-%d') if trade.exit_date else '' }}">
                    {{ trade.exit_date.strftime('%d/%m/%Y') if trade.exit_date else '-' }}
                </td>
                <td>{{ trade.quantity }}</td>
                <td>R$ {{ "%.2f"|format(trade.buy_price)|replace('.', ',') }}</td>
                <td>R$ {{ "%.2f"|format(trade.sell_price)|replace('.', ',') }}</td>
                <td class="{{ 'positive' if trade.profit_value >= 0 else 'negative' }}">
                    R$ {{ "%.2f"|format(trade.profit_value)|replace('.', ',') }}
                </td>
                <td class="{{ 'positive' if trade.profit_pct >= 0 else 'negative' }}">
                    {{ "%.2f"|format(trade.profit_pct)|replace('.', ',') }}%
                </td>
                <td>{{ trade.days_held }}</td>
                <td style="display: flex; gap: 5px; justify-content: center;">
                    <a href="{{ url_for('edit_history', id=trade.id) }}" class="btn btn-sm btn-info" style="color: white;" title="Editar">‚úèÔ∏è</a>
                    <a href="{{ url_for('delete_history', id=trade.id) }}" class="btn btn-sm btn-danger"
                        onclick="return confirm('Tem certeza que deseja excluir?')" title="Excluir">üóëÔ∏è</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Summary by Strategy -->
<div class="card mt-4">
    <div style="padding: 1rem;">
        <h3>Resumo por Estrat√©gia</h3>
    </div>
    <table>
        <thead>
            <tr>
                <th>Estrat√©gia</th>
                <th>Total Investido</th>
                <th>Lucro R$</th>
                <th>Lucro %</th>
            </tr>
        </thead>
        <tbody>
            {% set ns = namespace(total_invested=0, total_profit=0) %}
            {% for row in summary_table %}
            <tr>
                <td>{{ row.strategy }}</td>
                <td>R$ {{ "%.2f"|format(row.invested)|replace('.', ',') }}</td>
                <td class="{{ 'positive' if row.profit >= 0 else 'negative' }}">
                    R$ {{ "%.2f"|format(row.profit)|replace('.', ',') }}
                </td>
                <td class="{{ 'positive' if row.profit_pct >= 0 else 'negative' }}">
                    {{ "%.2f"|format(row.profit_pct)|replace('.', ',') }}%
                </td>
            </tr>
            {% set ns.total_invested = ns.total_invested + row.invested %}
            {% set ns.total_profit = ns.total_profit + row.profit %}
            {% endfor %}
        </tbody>
        <tfoot>
            <tr class="total-row" style="font-weight: bold; background-color: rgba(255,255,255,0.05);">
                <td>TOTAL</td>
                <td>R$ {{ "%.2f"|format(ns.total_invested)|replace('.', ',') }}</td>
                <td class="{{ 'positive' if ns.total_profit >= 0 else 'negative' }}">
                    R$ {{ "%.2f"|format(ns.total_profit)|replace('.', ',') }}
                </td>
                {% set total_pct = (ns.total_profit / ns.total_invested * 100) if ns.total_invested > 0 else 0 %}
                <td class="{{ 'positive' if total_pct >= 0 else 'negative' }}">
                    {{ "%.2f"|format(total_pct)|replace('.', ',') }}%
                </td>
            </tr>
        </tfoot>
    </table>
</div>

<!-- Chart: Profit by Strategy and Month -->
<div class="card mt-4">
    <div style="padding: 1rem;">
        <h3>Lucro por Estrat√©gia e M√™s (√∫ltimos 12 meses)</h3>
    </div>
    <div style="padding: 0 1rem 1rem; position: relative; height: 400px;">
        <canvas id="historyChart"></canvas>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function filterByStrategy() {
    const val = document.getElementById('strategyFilter').value;
    const rows = document.querySelectorAll('#historyTable tbody tr');
    rows.forEach(row => {
        if (!val || row.dataset.strategy === val) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// Bar Chart
const ctx = document.getElementById('historyChart').getContext('2d');
new Chart(ctx, {
    type: 'bar',
    data: {
        labels: {{ chart_labels | tojson }},
        datasets: {{ chart_datasets | tojson }}
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                labels: { color: '#f8fafc' }
            }
        },
        scales: {
            x: {
                stacked: false,
                ticks: { color: '#94a3b8' },
                grid: { color: 'rgba(255,255,255,0.05)' }
            },
            y: {
                ticks: {
                    color: '#94a3b8',
                    callback: function(value) {
                        return 'R$ ' + value.toLocaleString('pt-BR');
                    }
                },
                grid: { color: 'rgba(255,255,255,0.05)' }
            }
        }
    }
});
</script>
{% endblock %}
