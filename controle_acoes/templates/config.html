{% extends "base.html" %}

{% block content %}
<div class="card" style="max-width: 800px; margin: 0 auto;">
    <h2>Configura√ß√£o</h2>

    <div style="margin-bottom: 3rem;">
        <h3>Chave de API (BRAPI)</h3>
        <p style="color: var(--text-secondary); margin-bottom: 1rem;">
            Insira sua chave de acesso. Se estiver vazia, o sistema tentar√° usar a vari√°vel de ambiente ou o plano
            gratuito (limitado).
        </p>
        <form method="POST" action="{{ url_for('config') }}">
            <input type="hidden" name="action" value="save_brapi">
            <div class="form-group">
                <label for="api_key">Token API</label>
                <div style="display: flex; gap: 1rem;">
                    <input type="text" id="api_key" name="brapi_key" value="{{ '********' if current_key else '' }}"
                        placeholder="Ex: xxxxxxxxxx" style="flex: 1; margin-bottom: 0;">
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </div>
        </form>
    </div>

    <!-- MODO DE COTA√á√ÉO -->
    <div style="border-top: 1px solid var(--border-color); padding-top: 2rem; margin-bottom: 2rem;">
        <h3>Modo de Atualiza√ß√£o de Cota√ß√µes</h3>
        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
            Escolha como as cota√ß√µes de a√ß√µes e op√ß√µes ser√£o atualizadas nas tabelas do site.
        </p>

        <div style="display: flex; gap: 1.5rem; flex-wrap: wrap; margin-bottom: 1.5rem;">
            <!-- Card Yahoo -->
            <div style="flex: 1; min-width: 220px; padding: 1.2rem; border-radius: 10px;
                        border: 2px solid {{ 'var(--accent-color)' if quote_mode == 'yahoo' else 'var(--border-color)' }};
                        background: {{ 'var(--hover-bg)' if quote_mode == 'yahoo' else 'var(--card-bg)' }};">
                <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üìà</div>
                <strong>Yahoo Finance</strong>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin: 0.5rem 0 0;">
                    Cota√ß√µes atualizadas via internet (Yahoo Finance). N√£o atualiza pre√ßos de op√ß√µes.
                    Funciona em qualquer lugar.
                </p>
                {% if quote_mode == 'yahoo' %}
                <span style="display: inline-block; margin-top: 0.8rem; padding: 0.2rem 0.8rem;
                             background: var(--accent-color); color: white; border-radius: 20px; font-size: 0.8rem;">
                    ‚úì Modo ativo
                </span>
                {% endif %}
            </div>

            <!-- Card MT5 -->
            <div style="flex: 1; min-width: 220px; padding: 1.2rem; border-radius: 10px;
                        border: 2px solid {{ 'var(--success-color)' if quote_mode == 'mt5' else 'var(--border-color)' }};
                        background: {{ 'var(--hover-bg)' if quote_mode == 'mt5' else 'var(--card-bg)' }};">
                <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">‚ö°</div>
                <strong>MT5 Feeder (Tempo Real)</strong>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin: 0.5rem 0 0;">
                    Cota√ß√µes enviadas pelo script local conectado ao MetaTrader 5.
                    Atualiza a√ß√µes <strong>e op√ß√µes</strong> em tempo real. Requer feeder rodando no seu PC.
                </p>
                {% if quote_mode == 'mt5' %}
                <span style="display: inline-block; margin-top: 0.8rem; padding: 0.2rem 0.8rem;
                             background: var(--success-color); color: white; border-radius: 20px; font-size: 0.8rem;">
                    ‚úì Modo ativo
                </span>
                {% endif %}
            </div>
        </div>

        <form method="POST" action="{{ url_for('config') }}" style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <input type="hidden" name="action" value="set_quote_mode">
            <button type="submit" name="quote_mode" value="yahoo"
                class="btn {{ 'btn-primary' if quote_mode == 'yahoo' else 'btn-secondary' }}">
                Usar Yahoo Finance
            </button>
            <button type="submit" name="quote_mode" value="mt5"
                class="btn {{ 'btn-success' if quote_mode == 'mt5' else 'btn-secondary' }}">
                Usar MT5 Feeder
            </button>
        </form>
    </div>

    <div style="border-top: 1px solid var(--border-color); padding-top: 2rem;">
        <h3>Testar Conex√£o</h3>
        <p style="color: var(--text-secondary); margin-bottom: 1rem;">
            Informe um ticker para verificar se a API est√° retornando dados corretamente com a chave configurada.
        </p>

        <form method="POST" action="{{ url_for('test_api') }}" style="margin-bottom: 1rem;">
            <div class="form-group">
                <label for="ticker">Ticker</label>
                <div style="display: flex; gap: 1rem;">
                    <input type="text" id="ticker" name="ticker" placeholder="Ex: PETR4" required
                        style="flex: 1; margin-bottom: 0;">
                    <button type="submit" class="btn btn-primary">Testar</button>
                </div>
            </div>
        </form>

        {% if test_result %}
        <div
            style="background-color: var(--bg-color); padding: 1rem; border-radius: 0.5rem; border: 1px solid var(--border-color);">
            <div style="margin-bottom: 0.5rem;">
                Status:
                {% if success %}
                <span style="color: var(--success-color); font-weight: bold;">SUCESSO</span>
                {% else %}
                <span style="color: var(--danger-color); font-weight: bold;">ERRO</span>
                {% endif %}
            </div>
            <pre
                style="color: var(--text-secondary); font-family: monospace; white-space: pre-wrap; word-break: break-all;">{{ test_result }}</pre>
        </div>
        {% endif %}
    </div>
</div>

<div style="border-top: 1px solid var(--border-color); padding-top: 2rem; margin-top: 2rem;">
    <h3>Debug Yahoo Finance</h3>
    <p style="color: var(--text-secondary); margin-bottom: 1rem;">
        Acesse a ferramenta de debug para verificar dados brutos retornados pelo Yahoo Finance para qualquer ativo.
    </p>
    <a href="{{ url_for('debug_yahoo') }}" class="btn btn-warning">
        <i class="fas fa-bug mr-2"></i> Abrir Ferramenta de Debug
    </a>
</div>
</div>
{% endblock %}