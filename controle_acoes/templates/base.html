<!DOCTYPE html>
<html lang="pt-BR" data-bs-theme="dark">
<script>
    // Apply theme before render to avoid flash
    (function() {
        var theme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', theme);
        document.documentElement.setAttribute('data-bs-theme', theme);
    })();
</script>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Investimentos</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/investimento.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- Custom override for DataTables to match theme -->
    <style>
        .dataTables_wrapper .dataTables_length,
        .dataTables_wrapper .dataTables_filter,
        .dataTables_wrapper .dataTables_info,
        .dataTables_wrapper .dataTables_processing,
        .dataTables_wrapper .dataTables_paginate {
            color: var(--text-color);
            margin-bottom: 1rem;
        }

        table.dataTable tbody tr {
            background-color: transparent;
        }

        /* Robust Sticky Configuration for Excel-like Freeze Panes */
        table.dataTable {
            border-collapse: separate !important;
            border-spacing: 0;
        }

        /* Sticky Header (Vertical Freeze) */
        table.dataTable thead th {
            position: sticky;
            top: 0;
            z-index: 100;
            background-color: var(--table-header-bg) !important;
            border-bottom: 2px solid var(--border-color);
            box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.4);
        }

        /* Top-Left Intersection (Header "Ativo") - FORCE STICKY BOTH AXES */
        table.dataTable thead th:first-child {
            position: sticky !important;
            top: 0 !important;
            left: 0 !important;
            z-index: 200 !important;
            /* Highest priority */
            background-color: var(--table-header-bg) !important;
            border-right: 2px solid var(--border-color);
            box-shadow: 2px 2px 2px rgba(0, 0, 0, 0.4);
        }

        /* Sticky First Column (Body "Ativo") */
        table.dataTable tbody td:first-child {
            position: sticky;
            left: 0;
            z-index: 90 !important;
            background-color: var(--table-header-bg) !important;
            /* Ensure opacity */
            border-right: 2px solid var(--border-color);
            border-bottom: 1px solid var(--nav-mobile-border);
            box-shadow: 2px 0 2px -1px rgba(0, 0, 0, 0.4);
        }
    </style>
</head>

<body>
    <!-- Economic Indicators Bar -->
    {% if market_indices %}
    <div class="indicators-bar">
        <div class="close-indicators" onclick="toggleIndicators()" style="
            cursor: pointer; 
            padding: 0 15px; 
            font-size: 1.5rem; 
            color: #fff; 
            position: absolute; 
            right: 0; 
            z-index: 1002; 
            background: rgba(0,0,0,0.5); 
            height: 100%; 
            display: flex; 
            align-items: center;">&times;</div>
        <div class="indicators-track">
            {% for idx in market_indices %}
            <div class="indicator-item">
                <span class="indicator-name">{{ idx.name }}</span>
                <span class="indicator-price">{{ idx.price | brl if idx.name not in ['IBOV', 'Nasdaq', 'S&P 500', 'Dow
                    Jones'] else idx.price | int }}</span>
                <span class="indicator-change {{ 'positive' if idx.change_percent >= 0 else 'negative' }}">
                    {{ "%.2f"|format(idx.change_percent)|replace('.', ',') }}%
                </span>
            </div>
            {% endfor %}
            <!-- Duplicate for infinite scroll effect if needed, or just static list -->
            {% for idx in market_indices %}
            <div class="indicator-item">
                <span class="indicator-name">{{ idx.name }}</span>
                <span class="indicator-price">{{ idx.price | brl if idx.name not in ['IBOV', 'Nasdaq', 'S&P 500', 'Dow
                    Jones'] else idx.price | int }}</span>
                <span class="indicator-change {{ 'positive' if idx.change_percent >= 0 else 'negative' }}">
                    {{ "%.2f"|format(idx.change_percent)|replace('.', ',') }}%
                </span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="container">
        <header>
            <!-- Top row: Logo + Profile/Welcome -->
            <div class="header-top">
                <div class="header-brand">
                    <h1 class="mobile-title">
                        <img src="{{ url_for('static', filename='img/investimento.png') }}" alt="Logo"
                            style="height: 32px; margin-right: 10px;">
                        Minha Carteira
                    </h1>
                    <button class="menu-toggle" onclick="toggleMenu()"
                        style="background: none; border: none; color: white; font-size: 1.5rem; padding: 0; display: none;">‚ò∞</button>
                </div>
                <div class="header-user">
                    <span class="welcome-text">Bem vindo, <strong>{{ current_user.username }}</strong></span>
                    <form action="{{ url_for('update_quotes') }}" method="POST" style="margin: 0;">
                        <button type="submit" class="btn btn-secondary btn-sm">
                            üîÑ <span class="btn-label">Atualizar Cota√ß√µes</span>
                        </button>
                    </form>
                    <div class="dropdown">
                        <a href="#"
                            class="dropdown-toggle {{ 'active' if request.endpoint in ['profile', 'list_users', 'config'] else '' }}">
                            üë§ Perfil
                        </a>
                        <div class="dropdown-content">
                            <a href="{{ url_for('profile') }}">Minha Conta</a>
                            {% if current_user.is_admin %}
                            <a href="{{ url_for('list_users') }}">üë• Usu√°rios</a>
                            {% endif %}
                            <a href="{{ url_for('config') }}">‚öôÔ∏è APIs</a>
                            <div class="dropdown-divider"></div>
                            <a href="#" onclick="toggleIndicators(); return false;">üëÅÔ∏è Alternar Barra</a>
                            <a href="#" onclick="toggleTheme(); return false;">üåì Alternar Tema</a>
                            <div class="dropdown-divider"></div>
                            <a href="{{ url_for('logout') }}" style="color: var(--danger-color);">Sair</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Nav row -->
            <nav class="main-nav">
                <a href="{{ url_for('resumo') }}"
                    class="{{ 'active' if request.endpoint == 'resumo' else '' }}">Resumo</a>
                <a href="{{ url_for('acoes') }}"
                    class="{{ 'active' if request.endpoint == 'acoes' else '' }}">A√ß√µes</a>
                <a href="{{ url_for('fiis') }}"
                    class="{{ 'active' if request.endpoint == 'fiis' else '' }}">FIIs</a>
                <a href="{{ url_for('swingtrade') }}"
                    class="{{ 'active' if request.endpoint == 'swingtrade' else '' }}">Swingtrade</a>
                <a href="{{ url_for('opcoes') }}"
                    class="{{ 'active' if request.endpoint == 'opcoes' else '' }}">Op√ß√µes</a>
                <a href="{{ url_for('balanceamento') }}"
                    class="{{ 'active' if request.endpoint == 'balanceamento' else '' }}">Balanceamento</a>
                <a href="{{ url_for('dividendos') }}"
                    class="{{ 'active' if request.endpoint == 'dividendos' else '' }}">Dividendos</a>
                <a href="{{ url_for('history') }}"
                    class="{{ 'active' if request.endpoint == 'history' else '' }}">Hist√≥rico</a>
                <!-- Mobile-only user section inside nav -->
                <div class="nav-user-mobile">
                    <span class="welcome-text">Bem vindo, <strong>{{ current_user.username }}</strong></span>
                    <form action="{{ url_for('update_quotes') }}" method="POST" style="margin: 0.5rem 0;">
                        <button type="submit" class="btn btn-secondary btn-sm" style="width: 100%;">
                            üîÑ Atualizar Cota√ß√µes
                        </button>
                    </form>
                    <div class="nav-mobile-links">
                        <a href="{{ url_for('profile') }}">üë§ Minha Conta</a>
                        {% if current_user.is_admin %}
                        <a href="{{ url_for('list_users') }}">üë• Usu√°rios</a>
                        {% endif %}
                        <a href="{{ url_for('config') }}">‚öôÔ∏è APIs</a>
                        <a href="#" onclick="toggleIndicators(); return false;">üëÅÔ∏è Alternar Barra</a>
                        <a href="#" onclick="toggleTheme(); return false;">üåì Alternar Tema</a>
                        <a href="{{ url_for('logout') }}" style="color: var(--danger-color);">üö™ Sair</a>
                    </div>
                </div>
            </nav>

        </header>

        {% with messages = get_flashed_messages() %}
        {% if messages %}
        <div class="card" style="border-left: 4px solid var(--accent-color);">
            {% for message in messages %}
            <p>{{ message }}</p>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script>
        // Theme-aware chart colors helper
        function getThemeColors() {
            var s = getComputedStyle(document.documentElement);
            return {
                text: s.getPropertyValue('--text-primary').trim(),
                textSecondary: s.getPropertyValue('--text-secondary').trim(),
                border: s.getPropertyValue('--border-color').trim(),
                grid: s.getPropertyValue('--hover-bg').trim()
            };
        }
        var themeColors = getThemeColors();
    </script>
    <script>
        function toggleMenu() {
            var nav = document.querySelector('.main-nav');
            if (nav.style.display === 'flex') {
                nav.style.display = '';
                nav.classList.remove('active');
            } else {
                nav.style.display = 'flex';
                nav.classList.add('active');
            }
        }
    </script>
    <script>
        $(document).ready(function () {
            // General tables (default - no paging)
            $('table:not(.no-datatable):not(.paginated)').DataTable({
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json"
                },
                "paging": false,
                "info": false,
                "searching": false
            });

            // Paginated tables (Acoes/FIIs) - 25 items per page
            $('table.paginated').DataTable({
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json"
                },
                "paging": true,
                "pageLength": 25,
                "lengthChange": false,
                "info": false,
                "searching": false
            });
        });
    </script>
    <script>
        // Init Indicators Bar State
        document.addEventListener('DOMContentLoaded', function () {
            const isHidden = localStorage.getItem('hideIndicators') === 'true';
            const bar = document.querySelector('.indicators-bar');
            if (bar) {
                if (isHidden) {
                    bar.style.display = 'none';
                } else {
                    bar.style.display = 'flex';
                }

                // Add close button if not exists
                if (!bar.querySelector('.close-indicators')) {
                    const closeBtn = document.createElement('div');
                    closeBtn.className = 'close-indicators';
                    closeBtn.innerHTML = '&times;';
                    closeBtn.onclick = toggleIndicators;
                    closeBtn.style.cssText = 'cursor: pointer; padding: 0 10px; font-size: 1.2rem; color: #fff; position: absolute; right: 0; z-index: 1002; background: rgba(0,0,0,0.5); height: 100%; display: flex; align-items: center;';
                    bar.appendChild(closeBtn);
                    // Adjust scrolling container padding
                    const scrollContainer = bar.querySelector('.indicators-scroll');
                    if (scrollContainer) scrollContainer.style.paddingRight = '30px';
                }
            }
        });

        function toggleIndicators() {
            const bar = document.querySelector('.indicators-bar');
            if (bar) {
                if (bar.style.display === 'none') {
                    bar.style.display = 'flex';
                    localStorage.setItem('hideIndicators', 'false');
                } else {
                    bar.style.display = 'none';
                    localStorage.setItem('hideIndicators', 'true');
                }
            }
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme') || 'dark';
            const next = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', next);
            document.documentElement.setAttribute('data-bs-theme', next);
            localStorage.setItem('theme', next);
        }

    </script>
</body>

</html>